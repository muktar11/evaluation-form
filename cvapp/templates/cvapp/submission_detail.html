{% extends 'cvapp/base.html' %}
{% block content %}

<div class="card shadow-sm p-4 mb-4 text-end" dir="rtl">
  <h2 class="mb-3">{{ submission.الاسم }}</h2>

  <ul class="list-group list-group-flush mb-3">
    <li class="list-group-item"><strong>رقم الترشيح:</strong> {{ submission.رقم_الترشيح|default:"—" }}</li>
    <li class="list-group-item"><strong>الجنسية:</strong> {{ submission.الجنسية|default:"—" }}</li>
    <li class="list-group-item"><strong>العمر:</strong> {{ submission.العمر|default:"—" }}</li>
    <li class="list-group-item"><strong>اللغة:</strong> {{ submission.اللغة|default:"—" }}</li>
    <li class="list-group-item"><strong>الحالة الصحية أثناء المقابلة:</strong> {{ submission.الحالة_الصحية|default:"—" }}</li>
    <li class="list-group-item"><strong>الحالة النفسية:</strong> {{ submission.الحالة_النفسية|default:"—" }}</li>
    <li class="list-group-item"><strong>المهارات الأساسية:</strong> {{ submission.المهارات_الأساسية|linebreaks|default:"—" }}</li>

    {% if submission.الفيديو %}
    <li class="list-group-item">
      <strong>الفيديو:</strong> 
      <a href="{{ submission.الفيديو.url }}" target="_blank" class="btn btn-outline-primary btn-sm">عرض الفيديو المرفوع</a>
    </li>
    {% endif %}
  </ul>

  <div class="mt-3 d-flex gap-2 justify-content-end">
    <!-- زر نسخ رابط المعاينة -->
    <button id="copyBtn" class="btn btn-success btn-custom">📋 نسخ رابط المعاينة</button>

    <!-- زر الحجز -->
    <a href="{% url 'cvapp:book_submission' submission.المعرف %}" 
       class="btn btn-primary btn-custom {% if submission.تم_الحجز %}disabled{% endif %}">
       📖 {% if submission.تم_الحجز %}تم الحجز{% else %}حجز{% endif %}
    </a>
  </div>
</div>

<!-- إشعار النسخ -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="copyToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        ✅ تم نسخ رابط المعاينة إلى الحافظة بنجاح!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="إغلاق"></button>
    </div>
  </div>
</div>

<!-- كود الجافاسكربت -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const copyBtn = document.getElementById('copyBtn');
  const toastEl = document.getElementById('copyToast');
  const toast = new bootstrap.Toast(toastEl);

  copyBtn.addEventListener('click', function() {
    const url = '{{ request.scheme }}://{{ request.get_host }}{% url "cvapp:preview_submission" submission.المعرف %}';
    
    try {
      const textArea = document.createElement('textarea');
      textArea.value = url;
      document.body.appendChild(textArea);
      textArea.select();
      const successful = document.execCommand('copy');
      document.body.removeChild(textArea);

      if (successful) {
        toast.show();
      } else {
        alert('❌ فشل في نسخ الرابط، الرجاء النسخ يدويًا:\n' + url);
      }
    } catch (err) {
      alert('❌ فشل في نسخ الرابط، الرجاء النسخ يدويًا:\n' + url);
    }
  });
});
</script>

{% endblock %}
