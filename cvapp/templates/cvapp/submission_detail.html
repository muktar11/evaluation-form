{% extends 'cvapp/base.html' %}
{% block content %}

<div class="card shadow-sm p-4 mb-4 text-end" dir="rtl">
  <h2 class="mb-3">{{ submission.name }}</h2>

  <ul class="list-group list-group-flush mb-3">
    <li class="list-group-item"><strong>رقم الترشيح:</strong> {{ submission.passport_number }}</li>
    <li class="list-group-item"><strong>الجنسية:</strong> {{ submission.nationality }}</li>
    <li class="list-group-item"><strong>العمر:</strong> {{ submission.age }}</li>
    <li class="list-group-item"><strong>اللغة:</strong> {{ submission.language }}</li>
    <li class="list-group-item"><strong>الحالة الصحية أثناء المقابلة:</strong> {{ submission.health }}</li>
    <li class="list-group-item"><strong>المهارات:</strong> {{ submission.mental_state }}</li>
    <li class="list-group-item">
      <strong>الوصف الشخصي:</strong>
      <p class="mt-1">{{ submission.self_description|linebreaks }}</p>
    </li>
    {% if submission.video %}
    <li class="list-group-item">
      <strong>الفيديو:</strong> 
      <a href="{{ submission.video.url }}" target="_blank" class="btn btn-outline-primary btn-sm">عرض الفيديو المرفوع</a>
    </li>
    {% endif %}
  </ul>

  <div class="mt-3 d-flex gap-2 justify-content-end">
    <!-- زر نسخ الرابط -->
    <button id="copyBtn" class="btn btn-success btn-custom">📋 نسخ رابط المعاينة</button>

    <!-- زر الحجز -->
    <a href="{% url 'cvapp:book_submission' submission.id %}" class="btn btn-primary btn-custom">📖 حجز</a>
  </div>
</div>

<!-- ✅ إشعار النسخ -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="copyToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        ✅ تم نسخ رابط المعاينة إلى الحافظة بنجاح!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="إغلاق"></button>
    </div>
  </div>
</div>

<!-- ✅ كود الجافاسكربت -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const copyBtn = document.getElementById('copyBtn');
  const toastEl = document.getElementById('copyToast');
  const toast = new bootstrap.Toast(toastEl);

  copyBtn.addEventListener('click', function() {
    const url = '{{ request.scheme }}://{{ request.get_host }}{% url "cvapp:preview_submission" submission.id %}';
    
    try {
      // حل بديل للنسخ في حالة عدم دعم HTTPS
      const textArea = document.createElement('textarea');
      textArea.value = url;
      document.body.appendChild(textArea);
      textArea.select();
      const successful = document.execCommand('copy');
      document.body.removeChild(textArea);

      if (successful) {
        toast.show();
      } else {
        alert('❌ فشل في نسخ الرابط، الرجاء النسخ يدويًا:\n' + url);
      }
    } catch (err) {
      alert('❌ فشل في نسخ الرابط، الرجاء النسخ يدويًا:\n' + url);
    }
  });
});
</script>

{% endblock %}
